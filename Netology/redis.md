## Установка 

```
apt install redis
```
## Настройка[^1]

### Надо определиться с типом Бэкапа.

#### В Redis существует 3 модели работы с бэкапом:
    
    - RDB - создание бэкапов с определенными интервалами. Состоит из 1-ого файла;
    - AOF (append only file) - создание бэкапа после каждой записи данных (журналирование команд). Состоит из 2 файлов;
    - RDB+AOF - совмещает обе предыдущих модели, но по умолчанию будет восстанавливаться AOF т.к. имеет более актуальную информацию.
      Создание бэкапов так же можно отключить. По умолчанию включен RDB, а AOF отключен.
 
#### Настройка RDB 
 ```
 sudo vim /etc/redis/redis.conf
 ```
save <количество секунд> <количество изменений>
```
save 900 1
save 300 10
save 60 10000
```
> [!IMPORTANT]
> Т.е. выгрузка в файл происходит через определенный интервал и при условии какого-то количества изменений в базе. Если убрать эти строки, то вы отключите RDB.
> Создать бэкап можно так же через CLI выполнив одну из двух команд:
> SAVE - блокирует работу базы до создания бэкапа.
> BGSAVE - клонирует (fork()) существующий процесс Redis и выгружает его данные на диск. После этого процесс завершает работу. Таким образом нет блокировок, но возрастает требование к памяти.   
> Для примера вводим в консоле    
> redis-cli SAVE

Что бы восстановить подобный файл, мы должны выполнить следующее:

    - Остановить сервер Redis. Иначе файл будет перезаписан;
    - Скопировать файл с бэкапом в директорию где был создан бэкап. Названия меняться не должно. Т.е. если бэкап был взят по пути '/var/lib/redis/dump.rdb', то и восстанавливаться он будет отсюда;
    - Запустить Redis.
Порядок команд для восстановления:
```
sudo systemctl stop redis-server
sudo cp ./backup.rdb /var/lib/redis/dump.rdb
sudo systemctl start redis-server
```
#### Настройка AOF

 ```
 sudo vim /etc/redis/redis.conf
 ```

Работу с базой можно настроить через принцип логов (типа транзакционных логов в SQL базах). Каждая команда записи и изменения записывается в файл с расширением '.aof'. Из-за того что файл '.aof' хранит все выполненные команды (которые могут повторяться 100-ни раз), он может весомо превышать основной файл данных.

Когда файл '.aof' достигает критической отметки, установленной в настройках, он повторно выгружает все данные из памяти в новый файл. Так как выгрузка идет из памяти, а не из файла '.aof', у нас уже нет дубликатов. Если к серверу поступает какая-то новая команда она записывается в старый и новый файл. После полной выгрузки старый файл заменяется новым.

Изменить принцип работы бэкапа можно в конфигурационном файле. Кроме параметров журналирования есть и другие:

    - appendonly no - говорит, нужно ли выполнять AOF бэкап. По умолчанию отключен. Нужно установить 'yes' что бы включить;
    - appendfilename "appendonly.aof" - имя файла, которое будет создаваться при бэкапе и читаться при восстановлении;
    - appendfsync everysec - как часто нужно выполнять выгрузку. По умолчанию - каждую секунду. Можно так же установить параметр 'always' (сразу после изменения данных) и 'no' (раз в 30 секунд);
    - auto-aof-rewrite-min-size 64mb - минимальный размер AOF файла, после которого произойдет перезапись;
    - auto-aof-rewrite-percentage 100 - на сколько процентов должен увеличится размер файла после последней перезаписи. Если первая запись сработала при 64mb, то при значении 100%, она повторно сработает на 128mb. Значение 0 - отключение автоматической перезаписи. 
> [!WARNING]
> Перед включением AOF важно помнить, что если вы его только включили, то все данные будут стерты. После установки параметров и перезапуске сервера, Redis попробует прочитать файл с расширением '.aof'. Так как его нет - будет создан новый, пустой, файл. Избежать это можно установкой параметра через CLI:   
> sudo redis-cli   
> CONFIG SET appendonly yes   
> CONFIG REWRITE   

Что бы не ждать ситуации, когда файл журнала будет перезаписан, можно выполнить следующую команду:
```
BGREWRITEAOF
```

Что бы выполнить восстановление базы - вы так же должны остановить сервис Redis:   
```
sudo systemctl stop redis-server
sudo cp ./appendonly.aof /var/lib/redis/
sudo systemctl start redis-server
```
> [!IMPORTANT]
> Как уже писалось раньше, при включенном AOF и RDB, всегда будет искаться и восстанавливаться файл '.aof'. Из-за такого поведения, если вам нужно восстановить базу '.rdb', изначально вам нужно отключить AOF. Если вы и планировали восстанавливаться AOF, то вам просто нужно переместить файл по пути '/var/lib/redis/appendonly.aof', и включить сервер


## Проблемы и решения

- Если у вас появится ошибка '(error) ERR Rewriting config file: Permission denied', то попробуйте сменить владельца папки:
  ```
  sudo chown redis:redis /etc/redis/redis.conf
  ```
- Очень частая ошибка новичка при переносе или копировании инстанса Redis — это загрузка RDB дампа со старого инстанса в директорию /var/lib/redis до выключения нового инстанса. В результате, Redis после перезапуска автоматически сохраняет данные из ОЗУ на диск, затирая загруженный ранее RDB файл. Этот момент может показаться запредельно очевидным, однако, за время работы, мы часто встречали озадаченность со стороны клиентов, которые решали самостоятельно восстановиться из дампа и раз за разом после перезагрузки Redis получали старый набор данных.[^2]
- Если размер вашего RDB дампа больше 10Gb, вы можете столкнуться с тем, что Redis бесконечно поднимается с него. При чуть более дотошном анализе вы заметите, что после загрузки определенного количества данных в ОЗУ, Redis перезагружается и процесс загрузки данных начинается заново. Проблема в том, что по умолчанию в unit-файле Redis не выставлен явно параметр TimeoutStartSec, отвечающий за время ожидания старта. Если демон не сигнализирует о завершения запуска в течение настроенного времени, старт будет считаться неудавшимся и демон будет выключен. По умолчанию TimeoutStartSec равен 90 секундам и если Redis не успеет за это время загрузить данные в ОЗУ, то Redis будет перезагружен. Решение — установить параметр TimeoutStartSec=infinity.











---
[^1]: https://fixmypc.ru/post/ustanovka-bazy-dannykh-redis-na-ubuntu-20/?ysclid=lq0xd738e1589656970
[^2]: https://habr.com/ru/companies/nixys/articles/765694/
https://webdevblog.ru/redis-dlya-nachinajushhij/
